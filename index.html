<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Key Manager</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .profile { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        button { background-color: #4CAF50; color: white; border: none; padding: 5px 10px; cursor: pointer; margin-right: 5px; }
        button.delete { background-color: #f44336; }
        button.cancel { background-color: #9e9e9e; }
        .form-group { margin-bottom: 10px; }
        input, textarea { width: 100%; padding: 8px; }
        .edit-form { display: none; border: 1px solid #ccc; padding: 20px; margin-top: 20px; }
        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            border-radius: 8px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-pre {
            background-color: #eee;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap; /* Ensures text wraps */
            word-wrap: break-word; /* Breaks long words */
        }
    </style>
</head>
<body>
    <h1>API Key Manager</h1>

    <div id="profiles-container"></div>

    <div id="form-section">
        <div id="create-form">
            <h2>Create New Profile</h2>
            <div class="form-group">
                <label>Name:</label>
                <input type="text" id="profile-name" required>
            </div>
            <div class="form-group">
                <label>Base URL:</label>
                <input type="text" id="base-url">
            </div>
            <div class="form-group">
                <label>API Keys (comma-separated values):</label>
                <input type="text" id="api-keys">
            </div>
            <button id="create-btn">Create Profile</button>
        </div>

        <div id="edit-form" class="edit-form">
            <h2>Edit Profile</h2>
            <div class="form-group">
                <label>Name:</label>
                <input type="text" id="edit-profile-name" required>
            </div>
            <div class="form-group">
                <label>Base URL:</label>
                <input type="text" id="edit-base-url">
            </div>
            <div class="form-group">
                <label>API Keys (comma-separated values):</label>
                <input type="text" id="edit-api-keys">
            </div>
            <button id="update-btn">Update Profile</button>
            <button class="cancel" id="cancel-edit-btn">Cancel</button>
        </div>
    </div>

    <!-- The Modal -->
    <div id="apiResponseModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>API Test Response</h2>
            <pre id="modal-response-content" class="modal-pre"></pre>
        </div>
    </div>
 
    <script>
        const API_BASE = 'http://localhost:3025/profiles';
        let currentEditProfile = null;
        
        // DOM Elements
        const createForm = document.getElementById('create-form');
        const editForm = document.getElementById('edit-form');
        const createBtn = document.getElementById('create-btn');
        const updateBtn = document.getElementById('update-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');

        // Fetch and display profiles
        async function loadProfiles() {
            const response = await fetch(API_BASE);
            const profiles = await response.json();
            
            const container = document.getElementById('profiles-container');
            container.innerHTML = '';
            
            profiles.forEach(profile => {
                const profileEl = document.createElement('div');
                profileEl.className = 'profile';
                profileEl.innerHTML = `
                    <h3>${profile.name}</h3>
                    <p><strong>Base URL:</strong> ${profile.baseUrl || 'N/A'}</p>
                    <p><strong>Keys:</strong></p>
                    <pre>${JSON.stringify(profile.keys, null, 2)}</pre>
                    <button onclick="startEditProfile('${profile.name}')">Edit</button>
                    <button class="delete" onclick="deleteProfile('${profile.name}')">Delete</button>
                    <select id="key-select-${profile.name}" style="margin-left: 10px;">
                        ${Object.keys(profile.keys).map(key => `<option value="${key}">${key}</option>`).join('')}
                    </select>
                    <button class="test" onclick="testProfile('${profile.name}', document.getElementById('key-select-${profile.name}').value)">Test Connection</button>
                `;
                container.appendChild(profileEl);
            });
        }
        
        // Create new profile
        createBtn.addEventListener('click', async () => {
            const name = document.getElementById('profile-name').value;
            const baseUrl = document.getElementById('base-url').value;
            const keysInput = document.getElementById('api-keys').value;
            
            const keys = {};
            if (keysInput) {
                keysInput.split(',').forEach((value, index) => {
                    const key = `API_KEY_${index + 1}`; // Autogenerate key name
                    if (value.trim()) keys[key] = value.trim();
                });
            }
            
            const response = await fetch(API_BASE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, baseUrl, keys })
            });
            
            if (response.ok) {
                alert('Profile created successfully!');
                document.getElementById('profile-name').value = '';
                document.getElementById('base-url').value = '';
                document.getElementById('api-keys').value = '';
                loadProfiles();
            } else {
                const error = await response.json();
                alert(`Error: ${error.error}`);
            }
        });
        
        // Delete profile
        async function deleteProfile(name) {
            if (confirm(`Are you sure you want to delete profile "${name}"?`)) {
                const response = await fetch(`${API_BASE}/${name}`, { method: 'DELETE' });
                if (response.ok) {
                    loadProfiles();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            }
        }
        
        // Start editing a profile
        async function startEditProfile(name) {
            try {
                const response = await fetch(`${API_BASE}/${name}`);
                const profile = await response.json();
                
                currentEditProfile = profile;
                
                document.getElementById('edit-profile-name').value = profile.name;
                document.getElementById('edit-base-url').value = profile.baseUrl || '';
                
                // Format keys as string
                const keysStr = Object.values(profile.keys)
                    .join(',');
                document.getElementById('edit-api-keys').value = keysStr;
                
                // Show edit form, hide create form
                createForm.style.display = 'none';
                editForm.style.display = 'block';
            } catch (err) {
                alert(`Error loading profile: ${err.message}`);
            }
        }
        
        // Update profile
        updateBtn.addEventListener('click', async () => {
            if (!currentEditProfile) return;
            
            const name = document.getElementById('edit-profile-name').value;
            const baseUrl = document.getElementById('edit-base-url').value;
            const keysInput = document.getElementById('edit-api-keys').value;
            
            const keys = {};
            if (keysInput) {
                keysInput.split(',').forEach((value, index) => {
                    const key = `API_KEY_${index + 1}`; // Autogenerate key name
                    if (value.trim()) keys[key] = value.trim();
                });
            }
            
            try {
                const response = await fetch(`${API_BASE}/${currentEditProfile.name}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, baseUrl, keys })
                });
                
                if (response.ok) {
                    alert('Profile updated successfully!');
                    currentEditProfile = null;
                    cancelEdit();
                    loadProfiles();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (err) {
                alert(`Error updating profile: ${err.message}`);
            }
        });
        
        // Cancel edit
        function cancelEdit() {
            createForm.style.display = 'block';
            editForm.style.display = 'none';
            currentEditProfile = null;
        }
        
        cancelEditBtn.addEventListener('click', cancelEdit);
        
        // Test profile connection
        async function testProfile(name, keyName) {
            const modal = document.getElementById('apiResponseModal');
            const modalContent = document.getElementById('modal-response-content');
            const closeButton = document.getElementsByClassName('close-button')[0];

            modalContent.textContent = 'Testing...';
            modal.style.display = 'block'; // Show the modal

            // When the user clicks on <span> (x), close the modal
            closeButton.onclick = function() {
                modal.style.display = 'none';
            }

            // When the user clicks anywhere outside of the modal, close it
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }
            
            try {
                const response = await fetch('http://localhost:3025/test-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, keyName })
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    modalContent.textContent = `Error: Received non-JSON response: ${text.slice(0, 500)}`;
                    return;
                }
                
                const result = await response.json();
                
                if (result.valid) {
                    const modelsList = result.models.length > 0 ?
                        result.models.map(model => `• ${model}`).join('\n') : 'None';
                    modalContent.textContent = `✅ Connection successful!\nStatus: ${result.status}\nModels:\n${modelsList}`;
                } else {
                    modalContent.textContent = `❌ Connection failed!\nError: ${result.error || ''}\nStatus: ${result.status || ''}`;
                }
            } catch (err) {
                modalContent.textContent = `❌ Error: ${err.message}`;
            }
        }
        
        // Initial load
        loadProfiles();
    </script>
</body>
</html>